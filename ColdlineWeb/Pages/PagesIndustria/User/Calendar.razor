@using ColdlineWeb.Models
@using ColdlineWeb.Services
@inject ProcessService ProcessService

<link rel="stylesheet" href="css/Calendar.css" />

@if (ShowModal && !string.IsNullOrWhiteSpace(UserId))
{
    <div class="modal d-block">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Calend√°rio de @User?.Name</h5>
                    <button type="button" class="btn-close" @onclick="CloseModalInternal"></button>
                </div>
                <div class="modal-body">
                    @if (IsLoading)
                    {
                        <div class="loading-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="loading-text">Carregando dados do calend√°rio...</p>
                        </div>
                    }
                    else
                    {
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="btn btn-secondary" @onclick="PreviousMonth" disabled="@IsFirstMonth">‚Üê</button>
                                <span>@currentMonth.ToString("MMMM yyyy")</span>
                                <button class="btn btn-secondary" @onclick="NextMonth" disabled="@IsCurrentMonth">‚Üí</button>
                            </div>

                            <div class="calendar-grid">
                                <div class="calendar-day-header">Domingo</div>
                                <div class="calendar-day-header">Segunda</div>
                                <div class="calendar-day-header">Ter√ßa</div>
                                <div class="calendar-day-header">Quarta</div>
                                <div class="calendar-day-header">Quinta</div>
                                <div class="calendar-day-header">Sexta</div>
                                <div class="calendar-day-header">S√°bado</div>

                                @foreach (var day in DaysInCalendar)
                                {
                                    <div class="calendar-cell" @key="day">
                                        <span class="day-number">@day.Day</span>

                                        @if (ProcessData.TryGetValue(day.Date, out var info))
                                        {
                                            <div class="process-info">
                                                <div class="process-count">
                                                    <strong>@info.Count</strong> processo(s)
                                                </div>
                                                <div class="process-time">
                                                    <small>@info.TotalTime</small>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModalInternal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public UserModel? User { get; set; }
    [Parameter] public string? UserId { get; set; }
    [Parameter] public string? DepartmentId { get; set; }
    [Parameter] public EventCallback CloseModal { get; set; }

    private DateTime currentMonth = DateTime.Now;
    private List<DateTime> DaysInCalendar = new();
    private Dictionary<DateTime, (int Count, string TotalTime)> ProcessData = new();
    private bool IsLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        if (!ShowModal) return;

        UserId ??= User?.Id;

        if (!string.IsNullOrWhiteSpace(UserId))
            await BuildCalendar();
        else
        {
            DaysInCalendar.Clear();
            ProcessData.Clear();
        }
    }

    private bool IsCurrentMonth => currentMonth.Year == DateTime.Now.Year && currentMonth.Month == DateTime.Now.Month;
    private bool IsFirstMonth => currentMonth <= new DateTime(2000, 1, 1);

    private async Task PreviousMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        if (!string.IsNullOrWhiteSpace(UserId))
            await BuildCalendar();
    }

    private async Task NextMonth()
    {
        if (!IsCurrentMonth)
        {
            currentMonth = currentMonth.AddMonths(1);
            if (!string.IsNullOrWhiteSpace(UserId))
                await BuildCalendar();
        }
    }

    private async Task BuildCalendar()
    {
        if (string.IsNullOrWhiteSpace(UserId))
        {
            DaysInCalendar.Clear();
            ProcessData.Clear();
            return;
        }

        IsLoading = true;
        StateHasChanged();

        try
        {
            DaysInCalendar = Enumerable
                .Range(1, DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month))
                .Select(day => new DateTime(currentMonth.Year, currentMonth.Month, day))
                .ToList();

            ProcessData.Clear();

            // üî• Chama o novo endpoint otimizado
            var summaryList = await ProcessService.GetUserMonthlySummaryAsync(UserId, currentMonth.Year, currentMonth.Month);

            if (summaryList != null)
            {
                foreach (var item in summaryList)
                {
                    var day = item.Day.Date;
                    ProcessData[day] = (item.ProcessCount, item.TotalHours);
                }
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task CloseModalInternal()
    {
        await CloseModal.InvokeAsync();
    }
}
